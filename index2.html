<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>アリの巣シミュレーター ✦ 巣作り・探索・フェロモン</title>
  <!--
    ◇ 概要
      * 2D空間でアリが巣を作り、餌を探し、フェロモンで経路を共有するシミュレーター。
      * 巣・餌・アリ・フェロモンの可視化。
      * アリの行動はランダムウォーク＋フェロモン追従＋餌発見時の帰巣。
      * UIでアリ・餌の追加、フェロモン表示切替などが可能。
  -->
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #222;
      overflow: hidden;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    canvas {
      display: block;
      width: 100vw;
      height: 100vh;
      cursor: crosshair;
      background: #222;
    }
    #controls {
      position: fixed;
      bottom: 20px;
      left: 20px;
      display: flex;
      gap: 10px;
      background: rgba(40, 40, 60, 0.85);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(120, 140, 255, 0.35);
      box-shadow: 0 0 18px rgba(70, 130, 240, 0.35);
      pointer-events: all;
      z-index: 10;
    }
    button {
      background: rgba(60, 80, 170, 0.85);
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }
    button:hover {
      background: rgba(80, 100, 220, 0.95);
      box-shadow: 0 0 10px rgba(120, 170, 255, 0.7);
    }
    #stats {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(10, 10, 30, 0.75);
      color: #cce;
      border: 1px solid rgba(120, 140, 255, 0.35);
      padding: 8px 12px;
      border-radius: 8px;
      font: 12px/1.45 monospace;
      box-shadow: 0 0 15px rgba(70, 130, 240, 0.35);
      pointer-events: none;
      z-index: 10;
    }
  </style>
</head>
<body>
  <canvas id="sim"></canvas>
  <div id="controls">
    <button id="addAntBtn">アリ追加</button>
    <button id="addFoodBtn">餌追加</button>
    <button id="togglePheromoneBtn">フェロモン表示</button>
    <button id="resetBtn">リセット</button>
  </div>
  <div id="stats"></div>
  <script>
    // --- 基本設定 ---
    const cvs = document.getElementById("sim");
    const ctx = cvs.getContext("2d");
    let W = window.innerWidth, H = window.innerHeight;
    cvs.width = W;
    cvs.height = H;

    window.addEventListener("resize", () => {
      W = window.innerWidth;
      H = window.innerHeight;
      cvs.width = W;
      cvs.height = H;
    });

    // --- 巣・餌・アリ・フェロモン ---
    const nest = { x: W/2, y: H/2, r: 18 };
    const foods = [];
    const ants = [];
    const pheromones = []; // {x, y, strength, type: "toFood"|"toNest"}

    let showPheromone = true;

    // --- アリクラス ---
    class Ant {
      constructor(x, y) {
        this.x = x;
        this.y = y;
        this.angle = Math.random() * Math.PI * 2;
        this.carrying = false;
        this.target = null;
        this.trail = [];
      }
      update() {
        // 餌を持っていない場合：餌探索
        if (!this.carrying) {
          // 餌が近くにあれば拾う
          for (const food of foods) {
            const dx = food.x - this.x, dy = food.y - this.y;
            if (Math.hypot(dx, dy) < 10 && food.amount > 0) {
              this.carrying = true;
              food.amount--;
              this.target = { x: nest.x, y: nest.y };
              break;
            }
          }
          // フェロモン追従 or ランダムウォーク
          let best = null, bestStrength = 0;
          if (showPheromone) {
            for (const p of pheromones) {
              if (p.type === "toFood") {
                const d = Math.hypot(p.x - this.x, p.y - this.y);
                if (d < 30 && p.strength > bestStrength) {
                  best = p; bestStrength = p.strength;
                }
              }
            }
          }
          if (best && Math.random() < 0.8) {
            this.angle = Math.atan2(best.y - this.y, best.x - this.x) + rand(-0.3, 0.3);
          } else {
            this.angle += rand(-0.25, 0.25);
          }
        } else {
          // 餌を持っている場合：巣へ帰る
          const dx = nest.x - this.x, dy = nest.y - this.y;
          if (Math.hypot(dx, dy) < nest.r + 2) {
            this.carrying = false;
            this.target = null;
          } else {
            this.angle = Math.atan2(dy, dx) + rand(-0.15, 0.15);
          }
        }
        // 前進
        const speed = 1.5;
        this.x += Math.cos(this.angle) * speed;
        this.y += Math.sin(this.angle) * speed;
        // 壁で跳ね返り
        if (this.x < 0 || this.x > W) this.angle = Math.PI - this.angle;
        if (this.y < 0 || this.y > H) this.angle *= -1;
        // フェロモンを残す
        if (Math.random() < 0.05) {
          pheromones.push({ x: this.x, y: this.y, strength: 10, type: "toFood" });
        }
      }
      draw() {
        ctx.fillStyle = "#fff";
        ctx.beginPath();
        ctx.arc(this.x, this.y, 4, 0, Math.PI * 2);
        ctx.fill();

        // フェロモンの軌跡
        if (this.trail.length > 0) {
          ctx.strokeStyle = "rgba(255, 255, 255, 0.5)";
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(this.x, this.y);
          for (const p of this.trail) {
            ctx.lineTo(p.x, p.y);
          }
          ctx.stroke();
        }
      }
    }

    // --- 餌クラス ---
    class Food {
      constructor(x, y, amount = 5) {
        this.x = x;
        this.y = y;
        this.amount = amount;
      }
      draw() {
        ctx.fillStyle = "#ff0";
        ctx.beginPath();
        ctx.arc(this.x, this.y, 6, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    // --- フェロモン描画 ---
    function drawPheromones() {
      for (const p of pheromones) {
        ctx.fillStyle = p.type === "toFood" ? "rgba(255, 255, 0, 0.6)" : "rgba(255, 0, 0, 0.6)";
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.strength / 2, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    // --- 初期化 ---
    function init() {
      // 初期餌
      for (let i = 0; i < 10; i++) {
        const x = Math.random() * W;
        const y = Math.random() * H;
        foods.push(new Food(x, y, Math.floor(Math.random() * 10) + 5));
      }
      // 初期アリ
      for (let i = 0; i < 5; i++) {
        const x = W / 2 + Math.random() * 100 - 50;
        const y = H / 2 + Math.random() * 100 - 50;
        ants.push(new Ant(x, y));
      }
    }
    init();

    // --- メインループ ---
    function loop() {
      ctx.clearRect(0, 0, W, H);

      // フェロモン描画
      if (showPheromone) {
        drawPheromones();
      }

      // 巣
      ctx.fillStyle = "#fff";
      ctx.beginPath();
      ctx.arc(nest.x, nest.y, nest.r, 0, Math.PI * 2);
      ctx.fill();

      // 餌
      for (const food of foods) {
        food.draw();
      }

      // アリ
      for (const ant of ants) {
        ant.update();
        ant.draw();
      }

      // ステータス表示
      const stats = `アリ: ${ants.length} | 餌: ${foods.length} | フェロモン: ${pheromones.length}`;
      ctx.fillStyle = "#fff";
      ctx.font = "16px Arial";
      ctx.fillText(stats, 10, 20);

      requestAnimationFrame(loop);
    }
    loop();

    // --- UI イベント ---
    document.getElementById("addAntBtn").onclick = () => {
      const x = Math.random() * W;
      const y = Math.random() * H;
      ants.push(new Ant(x, y));
    };
    document.getElementById("addFoodBtn").onclick = () => {
      const x = Math.random() * W;
      const y = Math.random() * H;
      foods.push(new Food(x, y, Math.floor(Math.random() * 10) + 5));
    };
    document.getElementById("togglePheromoneBtn").onclick = () => {
      showPheromone = !showPheromone;
      const btn = document.getElementById("togglePheromoneBtn");
      btn.textContent = showPheromone ? "フェロモン非表示" : "フェロモン表示";
    };
    document.getElementById("resetBtn").onclick = () => {
      ants.length = 0;
      foods.length = 0;
      pheromones.length = 0;
      init();
    };
  </script>
</body>
</html>

