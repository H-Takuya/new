<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>アリの巣シミュレーター ✦ 巣作り・探索・フェロモン</title>
  <style>
    html, body { height: 100%; margin: 0; background: #222; overflow: hidden; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
    canvas { display: block; width: 100vw; height: 100vh; cursor: crosshair; background: #222; }
    #controls { position: fixed; bottom: 20px; left: 20px; display: flex; gap: 10px; background: rgba(40, 40, 60, 0.85); padding: 12px; border-radius: 8px; border: 1px solid rgba(120, 140, 255, 0.35); box-shadow: 0 0 18px rgba(70, 130, 240, 0.35); pointer-events: all; z-index: 10; }
    button { background: rgba(60, 80, 170, 0.85); color: #fff; border: none; padding: 8px 14px; border-radius: 5px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
    button:hover { background: rgba(80, 100, 220, 0.95); box-shadow: 0 0 10px rgba(120, 170, 255, 0.7); }
    #stats { position: fixed; bottom: 10px; right: 10px; background: rgba(10, 10, 30, 0.75); color: #cce; border: 1px solid rgba(120, 140, 255, 0.35); padding: 8px 12px; border-radius: 8px; font: 12px/1.45 monospace; box-shadow: 0 0 15px rgba(70, 130, 240, 0.35); pointer-events: none; z-index: 10; }
  </style>
</head>
<body>
  <canvas id="sim"></canvas>
  <div id="controls">
    <button id="addAntBtn">アリ追加</button>
    <button id="addFoodBtn">餌追加</button>
    <button id="togglePheromoneBtn">フェロモン表示</button>
    <button id="resetBtn">リセット</button>
  </div>
  <div id="stats"></div>
  <script>
    // --- 基本設定 ---
    const cvs = document.getElementById("sim");
    const ctx = cvs.getContext("2d");
    let W = window.innerWidth, H = window.innerHeight;
    cvs.width = W; cvs.height = H;
    window.addEventListener("resize", () => { W = window.innerWidth; H = window.innerHeight; cvs.width = W; cvs.height = H; });

    // --- 巣・餌・アリ・フェロモン ---
    const nest = { x: W/2, y: H/2, r: 18 };
    const foods = [];
    const ants = [];
    const pheromones = []; // {x, y, strength, type: "toFood"|"toNest"}
    let showPheromone = true;

    // --- アリクラス ---
    class Ant {
      constructor(x, y) {
        this.x = x; this.y = y;
        this.angle = Math.random() * Math.PI * 2;
        this.carrying = false;
        this.trail = [];
      }
      update() {
        // 餌を持っていない場合：餌探索
        if (!this.carrying) {
          // 餌が近くにあれば拾う
          for (const food of foods) {
            const dx = food.x - this.x, dy = food.y - this.y;
            if (Math.hypot(dx, dy) < 10 && food.amount > 0) {
              this.carrying = true;
              food.amount--;
              break;
            }
          }
          // フェロモン追従 or ランダムウォーク
          let best = null, bestStrength = 0;
          if (showPheromone) {
            for (const p of pheromones) {
              if (p.type === "toFood") {
                const d = Math.hypot(p.x - this.x, p.y - this.y);
                if (d < 30 && p.strength > bestStrength) {
                  best = p; bestStrength = p.strength;
                }
              }
            }
          }
          if (best && Math.random() < 0.8) {
            this.angle = Math.atan2(best.y - this.y, best.x - this.x) + rand(-0.3, 0.3);
          } else {
            this.angle += rand(-0.25, 0.25);
          }
        } else {
          // 餌を持っている場合：巣へ帰る
          const dx = nest.x - this.x, dy = nest.y - this.y;
          if (Math.hypot(dx, dy) < nest.r + 2) {
            this.carrying = false;
          } else {
            this.angle = Math.atan2(dy, dx) + rand(-0.15, 0.15);
          }
        }
        // 前進
        const speed = 1.5;
        this.x += Math.cos(this.angle) * speed;
        this.y += Math.sin(this.angle) * speed;
        // 壁で跳ね返る
        if (this.x < 5 || this.x > W-5) this.angle = Math.PI - this.angle;
        if (this.y < 5 || this.y > H-5) this.angle = -this.angle;
        // フェロモンを残す
        pheromones.push({
          x: this.x, y: this.y,
          strength: 1.0,
          type: this.carrying ? "toNest" : "toFood"
        });
        // トレイル
        this.trail.push({x: this.x, y: this.y});
        if (this.trail.length > 30) this.trail.shift();
      }
      draw() {
        // トレイル
        ctx.save();
        ctx.strokeStyle = this.carrying ? "#ffb30088" : "#4fc3f788";
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i = 0; i < this.trail.length; i++) {
          const p = this.trail[i];
          if (i === 0) ctx.moveTo(p.x, p.y);
          else ctx.lineTo(p.x, p.y);
        }
        ctx.stroke();
        ctx.restore();
        // 本体
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        ctx.fillStyle = this.carrying ? "#ffb300" : "#4fc3f7";
        ctx.beginPath();
        ctx.ellipse(0, 0, 6, 3, 0, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();
      }
    }

    // --- 餌クラス ---
    class Food {
      constructor(x, y) {
        this.x = x; this.y = y;
        this.amount = randInt(10, 30);
      }
      draw() {
        ctx.save();
        ctx.fillStyle = "#8bc34a";
        ctx.beginPath();
        ctx.arc(this.x, this.y, 7, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = "#fff";
        ctx.font = "10px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(this.amount, this.x, this.y+3);
        ctx.restore();
      }
    }

    // --- フェロモン減衰 ---
    function updatePheromones() {
      for (let i = pheromones.length - 1; i >= 0; i--) {
        pheromones[i].strength *= 0.97;
        if (pheromones[i].strength < 0.05) pheromones.splice(i, 1);
      }
    }

    // --- 描画 ---
    function drawAll() {
      ctx.clearRect(0, 0, W, H);
      // 巣
      ctx.save();
      ctx.fillStyle = "#795548";
      ctx.beginPath();
      ctx.arc(nest.x, nest.y, nest.r, 0, Math.PI*2);
      ctx.fill();
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.restore();
      // フェロモン
      if (showPheromone) {
        for (const p of pheromones) {
          ctx.save();
          ctx.globalAlpha = p.strength * 0.5;
          ctx.fillStyle = p.type === "toFood" ? "#4fc3f7" : "#ffb300";
          ctx.beginPath();
          ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
          ctx.fill();
          ctx.restore();
        }
      }
      // 餌
      for (const food of foods) if (food.amount > 0) food.draw();
      // アリ
      for (const ant of ants) ant.draw();
    }

    // --- メインループ ---
    function loop() {
      ants.forEach(a => a.update());
      updatePheromones();
      drawAll();
      document.getElementById("stats").textContent =
        `アリ: ${ants.length}　餌: ${foods.filter(f=>f.amount>0).length}　フェロモン: ${pheromones.length}`;
      requestAnimationFrame(loop);
    }

    // --- UIイベント ---
    document.getElementById("addAntBtn").onclick = () => ants.push(new Ant(nest.x + rand(-10,10), nest.y + rand(-10,10)));
    document.getElementById("addFoodBtn").onclick = () => foods.push(new Food(rand(30, W-30), rand(30, H-30)));
    document.getElementById("togglePheromoneBtn").onclick = () => {
      showPheromone = !showPheromone;
      document.getElementById("togglePheromoneBtn").textContent = showPheromone ? "フェロモン表示" : "フェロモン非表示";
    };
    document.getElementById("resetBtn").onclick = () => {
      ants.length = 0; foods.length = 0; pheromones.length = 0;
      for(let i=0;i<10;i++) ants.push(new Ant(nest.x + rand(-10,10), nest.y + rand(-10,10)));
      for(let i=0;i<3;i++) foods.push(new Food(rand(30, W-30), rand(30, H-30)));
    };

    // --- ユーティリティ ---
    function rand(a, b) { return Math.random() * (b - a) + a; }
    function randInt(a, b) { return Math.floor(rand(a, b + 1)); }

    // --- 初期化 ---
    for(let i=0;i<10;i++) ants.push(new Ant(nest.x + rand(-10,10), nest.y + rand(-10,10)));
    for(let i=0;i<3;i++) foods.push(new Food(rand(30, W-30), rand(30, H-30)));
    loop();
  </script>
</body>
</html>

